<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sell The Product</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    
    <style>
        /* --- CUSTOM THEME STYLES --- */
        :root { 
            --beamDegrees: 0deg; 
            --beamColor: #ef4444; 
        }

        body { 
            background: linear-gradient(135deg, #450a0a 0%, #000000 50%, #1a0505 100%);
            background-size: cover;
            background-attachment: fixed;
            min-height: 100vh; 
            margin: 0; 
            font-family: 'Inter', sans-serif; 
            color: #e5e7eb;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Dark Glass Panel */
        .glass-panel { 
            background: rgba(10, 10, 10, 0.65); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        /* Dark Inputs */
        .glass-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s;
            font-size: 16px; 
        }
        .glass-input:focus {
            border-color: #ef4444; 
            outline: none;
            background: rgba(0, 0, 0, 0.8);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }

        /* --- ANIMATIONS --- */
        @keyframes floatUpFade {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-40px) scale(1.2); }
        }
        .particle-float {
            position: absolute;
            animation: floatUpFade 1s ease-out forwards;
            pointer-events: none;
            z-index: 50;
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        @keyframes pulseBorder {
            0% { border-color: rgba(255,255,255,0.1); box-shadow: 0 0 0 rgba(239, 68, 68, 0); }
            50% { border-color: #ef4444; box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
            100% { border-color: rgba(255,255,255,0.1); box-shadow: 0 0 0 rgba(239, 68, 68, 0); }
        }
        .action-pulse {
            animation: pulseBorder 0.6s ease-in-out;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .feed-item-enter {
            animation: slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Login Beam Logic */
        .input-wrapper { position: relative; width: 100%; }
        #beam { position: absolute; top: 50%; right: 1.75rem; clip-path: polygon(100% 50%, 100% 50%, 0 0, 0 100%); width: 100vw; height: 40vw; z-index: 1; mix-blend-mode: screen; transition: transform 150ms ease-out; transform-origin: 100% 50%; transform: translateY(-50%) rotate(var(--beamDegrees, 0)); pointer-events: none; background: var(--beamColor); opacity: 0; }
        .show-password #beam { opacity: 0.6; }
        .show-password input#password { color: #ef4444 !important; border: 2px dashed #ef4444 !important; background: #1a1a1a !important; }
        .eye-icon { width: 20px; height: 20px; border: 2px solid #9ca3af; border-radius: 15px 0; transform: rotate(45deg); position: relative; }
        .show-password .eye-icon { border-color: #ef4444; }
        
        /* Chart Tooltip */
        .recharts-default-tooltip { 
            border-radius: 8px !important; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.5) !important; 
            border: 1px solid #374151 !important; 
            background-color: rgba(17, 24, 39, 0.95) !important; 
            color: #fff !important;
        }

        @media (max-width: 640px) {
            .glass-panel { padding: 1rem; }
            h1 { font-size: 1.25rem; }
            button { min-height: 44px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        // --- FIREBASE CONFIG (Add your keys here) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCg5JDoP_lfNKxg6XzRu0J5xevBLsx1JIo",
            authDomain: "sell-the-product.firebaseapp.com",
            projectId: "sell-the-product",
            storageBucket: "sell-the-product.firebasestorage.app",
            messagingSenderId: "1085888316819",
            appId: "1:1085888316819:web:324fa69a3a56a88b831466"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const { useState, useEffect, useMemo, useRef } = React;
        
        const Recharts = window.Recharts || {};
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } = Recharts;

        const COLORS = ['#ef4444', '#374151'];
        const BAR_COLOR = '#ef4444';

        function App() {
            if (!window.Recharts) return <div className="text-white p-10 font-mono">Loading Charts Library...</div>;

            const [user, setUser] = useState(null);
            const [users, setUsers] = useState([]); // Dynamic Users List
            const [products, setProducts] = useState([]);
            const [allocations, setAllocations] = useState([]);
            const [loading, setLoading] = useState(true);

            // Sync Users
            useEffect(() => {
                const q = query(collection(db, "users"));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedUsers = snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
                    
                    // Bootstrap Admin if empty
                    if (fetchedUsers.length === 0 && !loading) {
                        addDoc(collection(db, "users"), {
                            username: 'admin',
                            password: 'password',
                            role: 'ADMIN',
                            createdAt: Date.now()
                        });
                    } else {
                        setUsers(fetchedUsers);
                    }
                }, (e) => console.error(e));
                return () => unsubscribe();
            }, [loading]);

            // Sync Products
            useEffect(() => {
                const q = query(collection(db, "products"));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setProducts(snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id })));
                    setLoading(false);
                }, (e) => console.error(e));
                return () => unsubscribe();
            }, []);

            // Sync Allocations
            useEffect(() => {
                const q = query(collection(db, "allocations"));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setAllocations(snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id })));
                });
                return () => unsubscribe();
            }, []);

            const leaderboard = useMemo(() => {
                return users
                    .filter(u => u.role === 'USER')
                    .map(u => {
                        const totalRevenue = allocations
                            .filter(a => a.userId === u.docId) // Use docId
                            .reduce((sum, item) => sum + (Number(item.revenue) || 0), 0);
                        return { username: u.username, totalRevenue };
                    })
                    .sort((a, b) => b.totalRevenue - a.totalRevenue)
                    .slice(0, 5);
            }, [allocations, users]);

            const feedAllocations = useMemo(() => {
                const active = allocations.filter(a => a.sold > 0);
                if (user && user.role === 'ADMIN') return active;
                if (user) return active.filter(a => a.userId === user.docId);
                return [];
            }, [allocations, user]);

            const recordSale = async (allocationDocId, currentSold, currentRevenue, moneyGained, maxAllocated) => {
                const amount = parseFloat(moneyGained);
                if (isNaN(amount) || amount <= 0) return alert("Please enter a valid amount.");
                if (currentSold >= maxAllocated) return alert("Out of stock!");

                try {
                    const allocRef = doc(db, "allocations", allocationDocId);
                    await updateDoc(allocRef, {
                        sold: currentSold + 1,
                        revenue: currentRevenue + amount
                    });
                    return true;
                } catch (e) {
                    console.error("Error recording sale: ", e);
                    alert("Sync Error");
                    return false;
                }
            };

            const resetSystem = async () => {
                if(!confirm("DANGER: This deletes ALL Products and Allocations. Users are kept. Continue?")) return;
                allocations.forEach(async (a) => await deleteDoc(doc(db, "allocations", a.docId)));
                products.forEach(async (p) => await deleteDoc(doc(db, "products", p.docId)));
            }

            if (!user) return <LoginView users={users} onLogin={setUser} />;

            return (
                <div className="p-2 md:p-8 max-w-7xl mx-auto min-h-screen font-sans selection:bg-red-900 selection:text-white pb-20 md:pb-8 flex flex-col">
                    {/* Header */}
                    <header className="flex flex-col md:flex-row justify-between items-center mb-6 glass-panel p-4 md:p-6 rounded-2xl gap-4 sticky top-0 z-40 bg-black/80 backdrop-blur-xl border-b border-white/10 md:static">
                        <div className="text-center md:text-left">
                            <h1 className="text-xl md:text-2xl font-black text-white uppercase tracking-tight italic flex items-center justify-center md:justify-start gap-2">
                                <span className="text-red-500">‚Çπ</span> Sell The Product 
                                <span className="text-[10px] text-red-500 border border-red-900 bg-red-950/50 px-2 py-1 rounded not-italic tracking-widest animate-pulse">LIVE</span>
                            </h1>
                            <p className="text-xs text-gray-400 font-medium mt-1">User: <span className="text-white font-bold">{user.username}</span></p>
                        </div>
                        <div className="flex gap-2 w-full md:w-auto justify-center">
                             {user.role === 'ADMIN' && <button onClick={resetSystem} className="flex-1 md:flex-none border border-red-800 text-red-500 hover:bg-red-900/50 px-4 py-3 md:py-2 rounded-lg font-bold text-xs uppercase tracking-widest transition">Wipe Data</button>}
                            <button onClick={() => setUser(null)} className="flex-1 md:flex-none bg-white/10 hover:bg-white/20 text-white px-6 py-3 md:py-2 rounded-lg font-bold transition text-sm">Logout</button>
                        </div>
                    </header>

                    {/* Leaderboard */}
                    <div className="mb-8 overflow-x-auto pb-2">
                        <h2 className="text-xs font-bold mb-4 text-red-500 uppercase tracking-[0.2em] drop-shadow-md px-1">üèÜ Live Leaderboard</h2>
                        <div className="flex md:grid md:grid-cols-5 gap-4 min-w-[max-content] md:min-w-0 px-1">
                            {leaderboard.map((player, idx) => (
                                <div key={player.username} className={`w-40 md:w-auto flex-shrink-0 p-4 rounded-xl relative overflow-hidden transition-all duration-500 glass-panel ${idx === 0 ? 'border-red-500 shadow-[0_0_20px_rgba(239,68,68,0.3)] z-10' : 'border-white/5'}`}>
                                    {idx === 0 && <div className="absolute top-0 right-0 p-1 bg-red-600 text-[8px] font-bold text-black">TOP</div>}
                                    <div className="text-[10px] font-bold text-gray-500 uppercase">Rank {idx + 1}</div>
                                    <div className="text-sm font-black text-white truncate my-1">{player.username}</div>
                                    <div className="text-lg font-black text-red-400">‚Çπ{player.totalRevenue.toLocaleString('en-IN')}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <main className="lg:col-span-2 space-y-8">
                            
                            {/* Operations Panel */}
                            {user.role === 'ADMIN' ? (
                                <AdminPanel products={products} allocations={allocations} users={users} db={db} currentUser={user} />
                            ) : (
                                <UserPanel user={user} products={products} allocations={allocations} recordSale={recordSale} />
                            )}

                            {/* Analytics Panel */}
                            <div className="glass-panel p-4 md:p-6 rounded-2xl">
                                <h3 className="font-bold text-gray-400 mb-6 text-xs uppercase tracking-widest border-b border-white/10 pb-4">üìä Analytics</h3>
                                {user.role === 'ADMIN' ? (
                                    <AdminAnalytics allocations={allocations} users={users} />
                                ) : (
                                    <UserAnalytics userId={user.docId} allocations={allocations} />
                                )}
                            </div>
                        </main>
                        
                        {/* Feed Sidebar */}
                        <aside className="glass-panel p-4 md:p-6 rounded-2xl h-fit lg:sticky lg:top-4">
                            <h3 className="font-bold text-gray-400 mb-4 border-b border-white/10 pb-4 text-xs uppercase tracking-widest flex justify-between">
                                {user.role === 'ADMIN' ? 'Global Feed' : 'Team Feed'}
                                <span className="w-2 h-2 rounded-full bg-green-500 animate-ping"></span>
                            </h3>
                            <div className="space-y-3 overflow-hidden max-h-60 md:max-h-full overflow-y-auto">
                                {feedAllocations.length === 0 && (
                                    <div className="text-xs text-gray-600 italic">
                                        No sales yet.
                                    </div>
                                )}
                                {feedAllocations.slice(-8).reverse().map((a, i) => (
                                    <div key={a.docId + a.sold} className="feed-item-enter text-xs flex justify-between bg-black/40 border border-white/5 p-3 rounded-lg items-center hover:bg-white/5 transition">
                                        <div className="flex flex-col">
                                            <span className="font-bold text-gray-200">
                                                {user.docId === a.userId ? 'You' : users.find(u => u.docId === a.userId)?.username || 'Unknown'}
                                            </span>
                                            <span className="text-[10px] text-gray-500">Item: {products.find(p => p.id === a.productId)?.name || 'N/A'}</span>
                                        </div>
                                        <span className="text-green-400 font-bold font-mono">+‚Çπ{ (Number(a.revenue) / a.sold).toFixed(0) }</span>
                                    </div>
                                ))}
                            </div>
                        </aside>
                    </div>

                    {/* --- FOOTER COMPONENT ADDED HERE --- */}
                    <Footer />

                </div>
            );
        }

        // --- SUB COMPONENTS ---

        function Footer() {
            return (
                <footer className="mt-12 border-t border-white/10 pt-8 pb-4 flex flex-col md:flex-row items-center justify-between gap-4 text-xs text-gray-500 font-mono">
                    <div className="uppercase tracking-widest">
                        &copy; Zerone {new Date().getFullYear()} Sell The Product ,
                    </div>
                    <div className="flex items-center gap-2">
                        <span>Designed & Engineered by</span>
                        <a href="#" className="text-white font-bold hover:text-red-500 transition-colors border-b border-transparent hover:border-red-500 pb-0.5">
                            Roshen Reji <span className="text-xs font-normal">(S2CSE)</span>
                        </a>
                    </div>
                </footer>
            );
        }

        function LoginView({ onLogin, users }) {
            const [showPassword, setShowPassword] = useState(false);
            const [creds, setCreds] = useState({ username: '', password: '' });
            const beamRef = useRef(null);

            useEffect(() => {
                const handleMouseMove = (e) => {
                    if (!showPassword || !beamRef.current) return;
                    const rect = beamRef.current.getBoundingClientRect();
                    const degrees = (Math.atan2(rect.right - e.pageX, (rect.top + (rect.height / 2)) - e.pageY) * (20 / Math.PI) * -1) - 350;
                    document.documentElement.style.setProperty('--beamDegrees', `${degrees}deg`);
                };
                window.addEventListener('mousemove', handleMouseMove);
                if (showPassword) document.body.classList.add('login-body-dark');
                else document.body.classList.remove('login-body-dark');
                return () => { window.removeEventListener('mousemove', handleMouseMove); document.body.classList.remove('login-body-dark'); };
            }, [showPassword]);

            const handleSubmit = (e) => {
                e.preventDefault();
                // Check against passed 'users' prop which comes from Firestore
                const found = users.find(u => u.username === creds.username && u.password === creds.password);
                if (found) onLogin(found);
                else alert("Invalid credentials.");
            };

            return (
                <div className={`flex items-center justify-center min-h-screen px-4 ${showPassword ? 'show-password' : ''}`}>
                    <form onSubmit={handleSubmit} className={`p-6 md:p-10 rounded-2xl shadow-2xl w-full max-w-md z-10 transition-all ${showPassword ? 'bg-black border border-red-900' : 'glass-panel'}`}>
                        <h2 className={`text-2xl md:text-3xl font-black mb-8 text-center ${showPassword ? 'text-red-500' : 'text-white'}`}>Log In</h2>
                        <div className="mb-6"><label className={`block text-xs font-bold uppercase mb-2 ${showPassword ? 'text-gray-500' : 'text-gray-400'}`}>Username</label><input type="text" className={`w-full p-3 md:p-4 rounded-lg border-2 outline-none transition-all font-mono glass-input ${showPassword ? 'bg-gray-900 border-gray-800 text-white' : ''}`} onChange={e => setCreds({...creds, username: e.target.value})} required /></div>
                        <div className="mb-10"><label className={`block text-xs font-bold uppercase mb-2 ${showPassword ? 'text-gray-500' : 'text-gray-400'}`}>Password</label><div className="input-wrapper"><input id="password" type={showPassword ? "text" : "password"} className="w-full p-3 md:p-4 rounded-lg border-2 border-transparent glass-input outline-none focus:border-red-500 transition-all font-mono z-20 relative" onChange={e => setCreds({...creds, password: e.target.value})} required /><button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-4 top-1/2 -translate-y-1/2 z-30 outline-none"><div className="eye-icon"></div></button><div id="beam" ref={beamRef}></div></div></div>
                        <button className={`w-full py-4 rounded-lg font-black tracking-widest transition-colors shadow-lg uppercase ${showPassword ? 'bg-red-600 text-black hover:bg-red-500' : 'bg-white text-black hover:bg-gray-200'}`}>Log In</button>
                    </form>
                </div>
            );
        }

        function UserPanel({ user, products, allocations, recordSale }) {
            const myStock = allocations.filter(a => a.userId === user.docId);
            const [vals, setVals] = useState({});
            const [activeAnimations, setActiveAnimations] = useState([]);

            const handleSale = async (allocDocId, sold, revenue, price, allocated, event) => {
                const success = await recordSale(allocDocId, sold, revenue, price, allocated);
                
                if (success) {
                    const id = Date.now();
                    setActiveAnimations(prev => [...prev, { id, text: `+‚Çπ${price}`, type: 'float', allocDocId }]);
                    setTimeout(() => { setActiveAnimations(prev => prev.filter(a => a.id !== id)); }, 1000);
                    setVals({...vals, [allocDocId]: ''});
                }
            };

            return (
                <div className="glass-panel p-4 md:p-6 rounded-2xl">
                    <h3 className="font-bold mb-6 text-gray-400 uppercase tracking-tighter italic border-b border-white/10 pb-4">‚ö° Sale Input</h3>
                    {myStock.length === 0 ? <p className="text-gray-600 italic text-sm">No stock allocated.</p> : (
                        <div className="space-y-4">
                            {myStock.map(a => {
                                const p = products.find(prod => prod.id === a.productId);
                                if (!p) return null;
                                const isAnimating = activeAnimations.some(anim => anim.allocDocId === a.docId);

                                return (
                                    <div key={a.docId} className={`relative border border-white/5 p-4 rounded-xl flex flex-col md:flex-row items-center justify-between bg-black/20 gap-4 transition duration-200 ${isAnimating ? 'action-pulse' : ''}`}>
                                        {activeAnimations.filter(anim => anim.allocDocId === a.docId).map(anim => (
                                            <div key={anim.id} className="particle-float text-green-400 text-xl" style={{ right: '20px', top: '10px' }}>{anim.text}</div>
                                        ))}
                                        <div className="flex-grow text-center md:text-left w-full">
                                            <div className="font-black text-white text-lg">{p.name}</div>
                                            <div className="text-xs text-gray-500 mt-1 flex justify-center md:justify-start gap-3">
                                                <span>Stock: <strong className="text-white">{a.allocated - a.sold}</strong></span>
                                                <span>Rev: <strong className="text-red-400">‚Çπ{a.revenue}</strong></span>
                                            </div>
                                        </div>
                                        <div className="flex gap-2 relative w-full md:w-auto">
                                            <input type="number" className="glass-input p-3 rounded text-sm w-full md:w-24 outline-none text-center" placeholder="Price" value={vals[a.docId] || ''} onChange={e => setVals({...vals, [a.docId]: e.target.value})} />
                                            <button onClick={(e) => handleSale(a.docId, a.sold, a.revenue, vals[a.docId], a.allocated, e)} className="bg-red-600 hover:bg-red-700 active:scale-95 text-white px-6 py-3 rounded-lg font-bold shadow-sm whitespace-nowrap transition-transform">SELL</button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        }

        function AdminAnalytics({ allocations, users }) {
            const [selectedTeamId, setSelectedTeamId] = useState('');
            const barData = useMemo(() => {
                return users.filter(u => u.role === 'USER').map(u => {
                    const totalSold = allocations.filter(a => a.userId === u.docId).reduce((sum, item) => sum + (Number(item.sold) || 0), 0);
                    return { name: u.username, sold: totalSold };
                }).filter(d => d.sold > 0).sort((a,b) => b.sold - a.sold);
            }, [allocations, users]);

            const pieData = useMemo(() => {
                if(!selectedTeamId) return [];
                const teamAllocations = allocations.filter(a => a.userId === selectedTeamId);
                const totalSold = teamAllocations.reduce((sum, a) => sum + (a.sold || 0), 0);
                const totalAllocated = teamAllocations.reduce((sum, a) => sum + (a.allocated || 0), 0);
                const remaining = totalAllocated - totalSold;
                return [{ name: 'Sold', value: totalSold }, { name: 'Remaining', value: Math.max(0, remaining) }];
            }, [selectedTeamId, allocations]);

            return (
                <div className="space-y-8">
                    <div>
                        <h4 className="text-sm font-bold text-gray-500 mb-2">Team Volume</h4>
                        <div className="h-48 md:h-64 w-full bg-black/20 rounded-lg p-2 border border-white/5">
                            {barData.length > 0 ? (
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={barData}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#333" />
                                        <XAxis dataKey="name" tick={{fontSize: 10, fill: '#9ca3af'}} interval={0} angle={-15} textAnchor="end" stroke="#4b5563" />
                                        <YAxis tick={{fontSize: 10, fill: '#9ca3af'}} stroke="#4b5563" />
                                        <Tooltip cursor={{fill: 'rgba(255,255,255,0.05)'}} />
                                        <Bar dataKey="sold" fill={BAR_COLOR} radius={[4, 4, 0, 0]} name="Units Sold" />
                                    </BarChart>
                                </ResponsiveContainer>
                            ) : (<div className="h-full flex items-center justify-center text-gray-600 text-sm italic">No data.</div>)}
                        </div>
                    </div>
                    <div className="border-t border-white/10 pt-6">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-2">
                            <h4 className="text-sm font-bold text-gray-500">Utilization</h4>
                            <select className="glass-input p-2 rounded text-xs w-full md:w-auto" value={selectedTeamId} onChange={(e) => setSelectedTeamId(e.target.value)}>
                                <option value="" className="text-black">Select User</option>
                                {users.filter(u => u.role === 'USER').map(u => (<option key={u.docId} value={u.docId} className="text-black">{u.username}</option>))}
                            </select>
                        </div>
                        <div className="h-48 md:h-64 w-full flex items-center justify-center bg-black/20 rounded-lg border border-white/5">
                            {pieData.reduce((acc, curr) => acc + curr.value, 0) > 0 ? (
                                <ResponsiveContainer width="100%" height="100%">
                                    <PieChart>
                                        <Pie data={pieData} cx="50%" cy="50%" innerRadius={50} outerRadius={70} paddingAngle={5} dataKey="value" stroke="none">
                                            {pieData.map((entry, index) => (<Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />))}
                                        </Pie>
                                        <Tooltip />
                                        <Legend verticalAlign="bottom" height={36} wrapperStyle={{ color: '#9ca3af' }}/>
                                    </PieChart>
                                </ResponsiveContainer>
                            ) : (<div className="text-gray-600 text-sm italic">No allocation.</div>)}
                        </div>
                    </div>
                </div>
            );
        }

        function UserAnalytics({ userId, allocations }) {
            const pieData = useMemo(() => {
                const teamAllocations = allocations.filter(a => a.userId === userId);
                const totalSold = teamAllocations.reduce((sum, a) => sum + (a.sold || 0), 0);
                const totalAllocated = teamAllocations.reduce((sum, a) => sum + (a.allocated || 0), 0);
                const remaining = totalAllocated - totalSold;
                return [{ name: 'Sold', value: totalSold }, { name: 'Remaining', value: Math.max(0, remaining) }];
            }, [userId, allocations]);
            const hasData = pieData.reduce((acc, curr) => acc + curr.value, 0) > 0;
            return (
                <div className="flex flex-col items-center">
                    <h4 className="text-sm font-bold text-gray-500 mb-2 w-full text-left">Team Performance</h4>
                    <div className="h-48 md:h-64 w-full bg-black/20 rounded-lg border border-white/5">
                        {hasData ? (
                            <ResponsiveContainer width="100%" height="100%">
                                <PieChart>
                                    <Pie data={pieData} cx="50%" cy="50%" innerRadius={50} outerRadius={70} paddingAngle={5} dataKey="value" stroke="none">
                                        {pieData.map((entry, index) => (<Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />))}
                                    </Pie>
                                    <Tooltip />
                                    <Legend verticalAlign="bottom" wrapperStyle={{ color: '#9ca3af' }} />
                                </PieChart>
                            </ResponsiveContainer>
                        ) : (<div className="h-full flex items-center justify-center text-gray-600 text-sm italic">No data.</div>)}
                    </div>
                </div>
            )
        }

        function AdminPanel({ products, allocations, users, db, currentUser }) {
            // Inventory State
            const [name, setName] = useState('');
            const [qty, setQty] = useState(0);
            
            // Allocation State
            const [tUserId, setTUserId] = useState('');
            const [tProdDocId, setTProdDocId] = useState('');
            const [tQty, setTQty] = useState(0);

            // User Management State
            const [newUsername, setNewUsername] = useState('');
            const [newPassword, setNewPassword] = useState('');

            // --- INVENTORY ACTIONS ---
            const handleAddProduct = async () => {
                if(!name || qty <= 0) return;
                try {
                    await addDoc(collection(db, "products"), { id: Date.now(), name, centralStock: parseInt(qty) });
                    setName(''); setQty(0);
                } catch(e) { alert("Error adding product: " + e.message); }
            };

            // --- ALLOCATION ACTIONS ---
            const handleTransfer = async () => {
                const amount = parseInt(tQty);
                const prod = products.find(p => p.docId === tProdDocId);
                if (!prod || prod.centralStock < amount || !tUserId) return alert("Transfer failed.");
                try {
                    const prodRef = doc(db, "products", prod.docId);
                    await updateDoc(prodRef, { centralStock: prod.centralStock - amount });
                    
                    // Look for existing allocation using USER'S DOC ID
                    const existing = allocations.find(a => a.userId === tUserId && a.productId === prod.id);
                    if (existing) {
                        const allocRef = doc(db, "allocations", existing.docId);
                        await updateDoc(allocRef, { allocated: existing.allocated + amount });
                    } else {
                        await addDoc(collection(db, "allocations"), { userId: tUserId, productId: prod.id, allocated: amount, sold: 0, revenue: 0 });
                    }
                    setTQty(0);
                } catch(e) { alert("Error: " + e.message); }
            };

            // --- USER ACTIONS ---
            const handleAddUser = async () => {
                if (!newUsername || !newPassword) return alert("Fill all fields");
                try {
                    await addDoc(collection(db, "users"), {
                        username: newUsername,
                        password: newPassword,
                        role: 'USER',
                        createdAt: Date.now()
                    });
                    setNewUsername('');
                    setNewPassword('');
                } catch(e) { alert("Error adding user: " + e.message); }
            }

            const handleDeleteUser = async (userDocId) => {
                if(!confirm("Delete this user?")) return;
                try {
                    await deleteDoc(doc(db, "users", userDocId));
                } catch(e) { alert("Error deleting user: " + e.message); }
            }

            return (
                <div className="space-y-6">
                    {/* 1. Inventory */}
                    <div className="glass-panel p-4 md:p-6 rounded-2xl border-l-4 border-white/20">
                        <h3 className="font-bold mb-4 text-gray-200 text-lg">üì¶ Add Inventory</h3>
                        <div className="flex gap-2 flex-col md:flex-row">
                            <input className="glass-input p-3 rounded flex-grow" placeholder="Product Name" value={name} onChange={e => setName(e.target.value)} />
                            <input className="glass-input p-3 rounded w-full md:w-24" type="number" placeholder="Qty" value={qty} onChange={e => setQty(e.target.value)} />
                            <button onClick={handleAddProduct} className="bg-white hover:bg-gray-200 text-black px-6 py-3 rounded font-bold transition">ADD</button>
                        </div>
                    </div>

                    {/* 2. User Management (NEW) */}
                    <div className="glass-panel p-4 md:p-6 rounded-2xl border-l-4 border-blue-500">
                         <h3 className="font-bold mb-4 text-gray-200 text-lg">üë• User Management</h3>
                         <div className="flex gap-2 flex-col md:flex-row mb-6">
                            <input className="glass-input p-3 rounded flex-grow" placeholder="New Username" value={newUsername} onChange={e => setNewUsername(e.target.value)} />
                            <input className="glass-input p-3 rounded flex-grow" type="text" placeholder="Password" value={newPassword} onChange={e => setNewPassword(e.target.value)} />
                            <button onClick={handleAddUser} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded font-bold transition">CREATE</button>
                         </div>
                         <div className="bg-black/40 rounded-lg p-2 max-h-40 overflow-y-auto space-y-2">
                             {users.map(u => (
                                 <div key={u.docId} className="flex justify-between items-center p-2 border-b border-white/5 last:border-0">
                                     <div>
                                        <span className={`font-bold text-sm ${u.role === 'ADMIN' ? 'text-red-400' : 'text-gray-300'}`}>{u.username}</span>
                                        <span className="text-xs text-gray-600 ml-2">({u.role})</span>
                                     </div>
                                     {/* Prevent deleting yourself or other admins for safety, customizable */}
                                     {u.docId !== currentUser.docId && (
                                         <button onClick={() => handleDeleteUser(u.docId)} className="text-xs text-red-500 hover:text-red-400 font-bold border border-red-900/50 p-1 rounded">DELETE</button>
                                     )}
                                 </div>
                             ))}
                         </div>
                    </div>

                    {/* 3. Allocations */}
                    <div className="glass-panel p-4 md:p-6 rounded-2xl border-l-4 border-red-600">
                        <h3 className="font-bold mb-4 text-gray-200 text-lg">üöö Allocate Stock</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <select className="glass-input p-3 rounded w-full" onChange={e => setTProdDocId(e.target.value)} value={tProdDocId}>
                                <option value="" className="text-black">Select Product...</option>
                                {products.map(p => <option key={p.docId} value={p.docId} className="text-black">{p.name} ({p.centralStock})</option>)}
                            </select>
                            <select className="glass-input p-3 rounded w-full" onChange={e => setTUserId(e.target.value)} value={tUserId}>
                                <option value="" className="text-black">Select User...</option>
                                {users.filter(u => u.role === 'USER').map(u => <option key={u.docId} value={u.docId} className="text-black">{u.username}</option>)}
                            </select>
                        </div>
                        <input className="glass-input p-3 rounded w-full mb-4" type="number" placeholder="Quantity to Transfer" value={tQty} onChange={e => setTQty(e.target.value)} />
                        <button onClick={handleTransfer} className="w-full bg-red-700 text-white p-3 rounded font-bold shadow-md hover:bg-red-600 transition uppercase tracking-widest h-12">Transfer</button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>